<!DOCTYPE html>
<html>
<head>
    <title>Extract Dragon Points</title>
</head>
<body>
    <h1>Processing Image...</h1>
    <!-- Points to the new logo -->
    <img id="logo" src="/images/LogoTenryuAG.png" style="display:none;" crossorigin="anonymous"/>
    <div id="data">Waiting for image...</div>
    <canvas id="debugCanvas"></canvas>

    <script>
        window.onload = function() {
            const img = document.getElementById('logo');
            
            // Ensure image is loaded
            if (img.complete) {
                processImage();
            } else {
                img.onload = processImage;
            }

            function processImage() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // We want around 6000-7000 points to keep density similar
                    // The previous one had ~6229.
                    // This logo might be different aspect ratio.
                    // We'll target a resolution that gives us enough detail.
                    
                    // Let's create a temporary canvas to read pixel data
                    const targetCount = 15000; // Aim higher to capture details, then we filter
                    
                    // Calculate scale to hit approximate pixel count area
                    const scale = Math.sqrt(targetCount / (img.width * img.height));
                    
                    canvas.width = Math.floor(img.width * scale);
                    canvas.height = Math.floor(img.height * scale);
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    const points = [];
                    
                    console.log(`Processing ${canvas.width}x${canvas.height} image...`);

                    // Scan pixels
                    for (let y = 0; y < canvas.height; y++) {
                        for (let x = 0; x < canvas.width; x++) {
                            const index = (y * canvas.width + x) * 4;
                            const alpha = data[index + 3];
                            
                            // If pixel is visible (not transparent)
                            if (alpha > 128) {
                                // Normalize coordinates to roughly [-5, 5] range or similar to match 3D scene
                                // Previous logic: (x / width - 0.5) * 5
                                
                                const normalizedX = (x / canvas.width - 0.5) * 5; 
                                // Invert Y because Canvas Y is down, 3D Y is up
                                // Also adjust aspect ratio
                                const aspect = canvas.height / canvas.width;
                                const normalizedY = -(y / canvas.height - 0.5) * 5 * aspect; 
                                
                                points.push(normalizedX, normalizedY, 0); 
                            }
                        }
                    }
                    
                    document.getElementById('data').textContent = `Found ${points.length/3} points. Sending to server...`;

                    fetch('/save', {
                        method: 'POST',
                        body: JSON.stringify(points)
                    }).then(() => {
                        document.getElementById('data').textContent = `Saved ${points.length/3} points!`;
                    }).catch(e => {
                        document.getElementById('data').textContent = "Error saving: " + e;
                    });

                    // Debug view
                    const debugCanvas = document.getElementById('debugCanvas');
                    debugCanvas.width = canvas.width;
                    debugCanvas.height = canvas.height;
                    debugCanvas.getContext('2d').drawImage(canvas, 0,0);

                } catch(e) {
                    document.getElementById('data').textContent = "Error processing: " + e;
                    console.error(e);
                }
            }
        };
    </script>
</body>
</html>
